---
title: Database Migrations
sidebar_position: 1
description: Code-first database schema management using PHP attributes.
---

# Database Migrations & Schema Management

Strux provides a **code-first migration system** inspired by Prisma and TypeORM — but built entirely with **native PHP attributes**.

Your **models are the single source of truth** for the database schema.

---

## Key Features

- Code-first schema definition
- Automatic diff-based migrations
- Smart PHP → SQL type inference
- Safe column renaming
- Automatic pivot tables
- Relationship-driven foreign keys

---

## CLI Commands

| Command | Description |
|------|------------|
| `db:init` | Initialize migration system |
| `db:migrate` | Generate migration diff |
| `db:upgrade` | Apply pending migrations |
| `db:downgrade` | Roll back last batch |
| `db:reset` | ⚠ Drop DB and re-run |
| `db:fresh` | ⚠ Rebuild schema from scratch |
| `db:history` | Show migration history |
| `db:seed` | Run seeders |

---

## Defining Models

Models define your database schema.

```php
namespace App\Models;

use App\Core\Database\Attributes\Table;
use App\Core\Database\Attributes\Id;
use App\Core\Database\Attributes\Column;
use App\Core\Database\Types\Field;
use App\Core\Model\Model;
use DateTime;

#[Table('users')]
class User extends Model
{
    #[Id, Column]
    public ?int $id = null;

    #[Column]
    public string $username;

    #[Column(type: Field::text, nullable: true)]
    public ?string $bio = null;

    #[Column(type: Field::enum, enums: ['active', 'banned'], default: 'active')]
    public string $status = 'active';

    #[Column(type: Field::timestamp, currentTimestamp: true)]
    public DateTime $createdAt;

    #[Column(type: Field::timestamp, currentTimestamp: true, onUpdateCurrentTimestamp: true)]
    public DateTime $updatedAt;
}
````

---

## Available Attributes

### `#[Table]`

Defines the table name.

### `#[Id]`

Marks the primary key.

### `#[Column]`

Supports:

* `type`
* `length`
* `nullable`
* `unique`
* `default`
* `currentTimestamp`
* `onUpdateCurrentTimestamp`

### `#[RenamedFrom]`

Safely rename columns without data loss.

---

## Relationships & Foreign Keys

### BelongsTo

```php
#[BelongsTo(User::class, onDelete: 'CASCADE')]
public User $user;
```

Automatically generates:

* `user_id` column
* Foreign key constraint

---

### Many-to-Many

```php
#[BelongsToMany(Role::class, 'user_roles', 'user_id', 'role_id')]
public Collection $roles;
```

Creates a pivot table with foreign keys.

---

## Migration Workflow

1. Create or modify a model
2. Generate migration

```bash
php console db:migrate
```

3. Review SQL (destructive ops are commented)
4. Apply migration

```bash
php console db:upgrade
```

---

## Resetting Development Databases

When things get messy:

```bash
php console db:fresh
```