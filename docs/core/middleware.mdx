---
title: Middleware
slug: /middleware
description: Intercepting and filtering HTTP requests with PSR-15 Middleware.
---

# Middleware

Middleware provides a powerful mechanism for **intercepting and filtering HTTP requests** entering your application.  
They act as layers of an **onion**, surrounding your core application logic.

Common use cases include:

- Authenticating users
- Checking CSRF tokens
- Trimming or sanitizing input
- Logging requests
- Handling CORS headers

---

## The PSR-15 Standard

Strux is fully compatible with **PSR-15 (HTTP Server Request Handlers)**.

This means:

- Middleware must implement `Psr\Http\Server\MiddlewareInterface`
- You can reuse middleware from the wider PHP ecosystem
- Your application stays framework-agnostic and interoperable

---

## Creating Middleware

Let’s create a middleware that ensures the user is an administrator.

```php
namespace App\Http\Middleware;

use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Server\MiddlewareInterface;
use Psr\Http\Server\RequestHandlerInterface;
use Strux\Component\Http\Response;

class EnsureUserIsAdmin implements MiddlewareInterface
{
    public function process(
        ServerRequestInterface $request,
        RequestHandlerInterface $handler
    ): ResponseInterface {
        // Logic before the controller
        $role = $request->getAttribute('user_role');

        if ($role !== 'admin') {
            return new Response(403, [], 'Access Denied: Admins Only');
        }

        // Continue to the next middleware / controller
        $response = $handler->handle($request);

        // Logic after the controller
        return $response->withHeader('X-Checked-By', 'AdminMiddleware');
    }
}
````

---

## Registering Middleware

Strux supports middleware at **three different levels**.

---

### 1️⃣ Global Middleware

Global middleware runs on **every HTTP request**.

Typical examples include:

* Sessions
* CSRF protection
* Request body parsing
* CORS handling

Registered during bootstrapping:

```php
$app = Bootstrap::create(ROOT_PATH);

// Global middleware stack
$app->addMiddleware(
    new \Strux\Component\Middleware\CsrfProtectionMiddleware()
);

$app->addMiddleware(
    new \App\Http\Middleware\LogRequests()
);
```

---

### 2️⃣ Route Middleware (Attributes)

Apply middleware to **individual routes** using the `#[Middleware]` attribute.

```php
use Strux\Component\Attributes\Route;
use Strux\Component\Attributes\Middleware;
use App\Http\Middleware\EnsureUserIsAdmin;

class DashboardController
{
    #[Route('/admin/settings')]
    #[Middleware(EnsureUserIsAdmin::class)]
    public function settings()
    {
        // Only accessible to admins
    }
}
```

---

### 3️⃣ Controller Middleware

Apply middleware to an entire controller by attaching the attribute at the class level.

```php
use Strux\Component\Attributes\Middleware;

#[Middleware(EnsureUserIsAdmin::class)]
class AdminController
{
    public function index() {}
    public function users() {}
}
```

All controller actions will be protected.

---

## Passing Data via Request Attributes

Middleware often needs to pass data (such as the authenticated user) to controllers.

Since PSR-7 requests are **immutable**, you must use `withAttribute()`.

### In Middleware

```php
public function process($request, $handler): ResponseInterface
{
    $user = $this->authService->getUser();

    $request = $request->withAttribute('current_user', $user);

    return $handler->handle($request);
}
```

### In Controller

```php
public function index(Request $request)
{
    $user = $request->getAttribute('current_user');
}
```

---

## Middleware Execution Order

Middleware follows a **Last In, First Out (LIFO)** — or **onion-style** — execution model.

### Request Flow (Inbound)

```
Global Middleware
  → Route Middleware
    → Controller
```

### Response Flow (Outbound)

```
Controller
  → Route Middleware
    → Global Middleware
```

This allows middleware to:

* Inspect requests **before** controllers run
* Modify responses **after** controllers return them

Common outbound use cases include:

* Adding headers
* Response compression
* CORS headers
* Debug instrumentation

---

## Summary

* Strux middleware is **PSR-15 compliant**
* Middleware can be applied globally, per-route, or per-controller
* Requests are immutable — use attributes to pass data
* Middleware wraps controllers in an onion-like structure

---

Next, explore:

* **Request Life Cycle** to see middleware in action
* **Dependency Injection** for injecting services into middleware
* **Routing** to understand route-level middleware placement